<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Research Assistant - Full RAG System</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script type="module" src="https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2"></script>
  <script type="module" src="https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm@0.2.46/lib/index.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    .chat-message {
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .citation-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      margin: 2px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .citation-badge:hover {
      transform: scale(1.1);
    }
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 min-h-screen">
  <div class="container mx-auto px-4 py-6 max-w-7xl">
    <!-- Header -->
    <div class="text-center mb-6">
      <h1 class="text-4xl font-bold text-white mb-2">üìö AI Research Assistant</h1>
      <p class="text-white text-lg opacity-90">Full RAG Pipeline: Upload PDFs ‚Üí Chat with AI</p>
      <div class="mt-3 flex justify-center gap-3">
        <span id="embeddingStatus" class="px-4 py-2 rounded-full text-sm font-semibold bg-yellow-400 text-gray-900">
          Loading Embeddings...
        </span>
        <span id="llmStatus" class="px-4 py-2 rounded-full text-sm font-semibold bg-yellow-400 text-gray-900">
          Loading LLM...
        </span>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Left Column: PDF Upload & Memory Bank -->
      <div class="lg:col-span-1 space-y-6">
        <!-- PDF Upload Card -->
        <div class="bg-white rounded-xl shadow-2xl p-6">
          <h2 class="text-xl font-bold text-gray-800 mb-4 border-b-2 border-indigo-500 pb-2">
            üìÑ Document Ingestion
          </h2>
          
          <div id="dropZone" class="border-3 border-dashed border-indigo-400 rounded-lg p-8 text-center cursor-pointer hover:bg-indigo-50 transition-all">
            <div class="text-5xl mb-3">üìÑ</div>
            <div class="text-indigo-600 font-semibold mb-2">Drop PDFs here or click</div>
            <div class="text-gray-500 text-sm">Supports multiple files</div>
          </div>
          <input type="file" id="fileInput" class="hidden" accept=".pdf" multiple>

          <!-- Stats -->
          <div class="grid grid-cols-2 gap-3 mt-4">
            <div class="bg-gradient-to-br from-indigo-500 to-purple-600 text-white p-4 rounded-lg text-center">
              <div class="text-3xl font-bold" id="fileCount">0</div>
              <div class="text-sm opacity-90">PDFs</div>
            </div>
            <div class="bg-gradient-to-br from-purple-500 to-pink-600 text-white p-4 rounded-lg text-center">
              <div class="text-3xl font-bold" id="vectorCount">0</div>
              <div class="text-sm opacity-90">Vectors</div>
            </div>
          </div>

          <div id="processingStatus" class="mt-4"></div>
        </div>

        <!-- Memory Bank -->
        <div class="bg-white rounded-xl shadow-2xl p-6">
          <h2 class="text-xl font-bold text-gray-800 mb-4 border-b-2 border-indigo-500 pb-2">
            üíæ Memory Bank
          </h2>
          <div id="memoryBank" class="bg-gradient-to-br from-indigo-500 to-purple-600 text-white p-4 rounded-lg">
            <div class="text-center opacity-80 text-sm">No documents loaded</div>
          </div>
          <button id="clearBtn" class="w-full mt-4 bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
            Clear All Data
          </button>
        </div>
      </div>

      <!-- Right Column: Chat Interface -->
      <div class="lg:col-span-2">
        <div class="bg-white rounded-xl shadow-2xl h-[calc(100vh-200px)] flex flex-col">
          <!-- Chat Header -->
          <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-4 rounded-t-xl">
            <h2 class="text-xl font-bold">üí¨ Chat with Your Documents</h2>
            <p class="text-sm opacity-90">Ask questions about your uploaded PDFs</p>
          </div>

          <!-- Chat Messages -->
          <div id="chatContainer" class="flex-1 overflow-y-auto p-6 space-y-4 bg-gray-50">
            <div class="text-center text-gray-500 py-8">
              <div class="text-4xl mb-2">ü§ñ</div>
              <p>Upload PDFs and start chatting!</p>
            </div>
          </div>

          <!-- Chat Input -->
          <div class="border-t border-gray-200 p-4 bg-white rounded-b-xl">
            <div class="flex gap-3">
              <input 
                type="text" 
                id="chatInput" 
                placeholder="Ask a question about your documents..." 
                class="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none"
                disabled
              >
              <button 
                id="sendBtn" 
                class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-6 py-3 rounded-lg transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed"
                disabled
              >
                Send
              </button>
            </div>
            <div class="mt-2 text-xs text-gray-500 text-center" id="inputHint">
              Waiting for models to load...
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // ============================================
    // PDF Processor Module
    // ============================================
    const PDFProcessor = (() => {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 
        'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

      async function extractTextFromPDF(file) {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        let fullText = '';
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const textContent = await page.getTextContent();
          const pageText = textContent.items.map(item => item.str).join(' ');
          fullText += pageText + '\n';
        }
        return fullText;
      }

      function chunkText(text, chunkSize = 500, overlap = 100) {
        const chunks = [];
        let start = 0;
        text = text.replace(/\s+/g, ' ').trim();
        while (start < text.length) {
          const end = Math.min(start + chunkSize, text.length);
          const chunk = text.slice(start, end);
          if (chunk.trim().length > 0) {
            chunks.push(chunk.trim());
          }
          start += chunkSize - overlap;
        }
        return chunks;
      }

      async function processFile(file) {
        const text = await extractTextFromPDF(file);
        const chunks = chunkText(text);
        return {
          name: file.name,
          size: file.size,
          chunks: chunks,
          charCount: text.length,
          chunkCount: chunks.length
        };
      }

      return { processFile };
    })();

    // ============================================
    // Embeddings Engine Module
    // ============================================
    const EmbeddingsEngine = (() => {
      let pipeline = null;
      let isReady = false;

      async function initialize() {
        try {
          console.log('üîÑ Loading embedding model...');
          const { pipeline: pipelineFn } = await import('https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2');
          pipeline = await pipelineFn('feature-extraction', 'Xenova/all-MiniLM-L6-v2');
          isReady = true;
          console.log('‚úÖ Embedding model ready');
          return true;
        } catch (error) {
          console.error('‚ùå Embedding model failed:', error);
          throw error;
        }
      }

      async function generateEmbedding(text) {
        if (!isReady) throw new Error('Embeddings not ready');
        const output = await pipeline(text, { pooling: 'mean', normalize: true });
        return Array.from(output.data);
      }

      async function generateBatchEmbeddings(texts, onProgress) {
        const embeddings = [];
        for (let i = 0; i < texts.length; i++) {
          embeddings.push(await generateEmbedding(texts[i]));
          if (onProgress) onProgress(i + 1, texts.length);
        }
        return embeddings;
      }

      return { initialize, generateEmbedding, generateBatchEmbeddings };
    })();

    // ============================================
    // Vector Store Module
    // ============================================
    const VectorStore = (() => {
      const store = [];

      function cosineSimilarity(vecA, vecB) {
        let dotProduct = 0, normA = 0, normB = 0;
        for (let i = 0; i < vecA.length; i++) {
          dotProduct += vecA[i] * vecB[i];
          normA += vecA[i] * vecA[i];
          normB += vecB[i] * vecB[i];
        }
        const denominator = Math.sqrt(normA) * Math.sqrt(normB);
        return denominator === 0 ? 0 : dotProduct / denominator;
      }

      function addVectors(entries) {
        entries.forEach(entry => {
          store.push({
            id: store.length,
            text: entry.text,
            embedding: entry.embedding,
            source: entry.source,
            timestamp: new Date().toISOString()
          });
        });
      }

      async function search(queryEmbedding, topK = 5) {
        if (store.length === 0) return [];
        const results = store.map(item => ({
          ...item,
          similarity: cosineSimilarity(queryEmbedding, item.embedding)
        }));
        results.sort((a, b) => b.similarity - a.similarity);
        return results.slice(0, topK);
      }

      function clear() {
        store.length = 0;
      }

      function getStats() {
        return {
          count: store.length,
          sources: [...new Set(store.map(item => item.source))]
        };
      }

      return { addVectors, search, clear, getStats };
    })();

    // ============================================
    // LLM Engine Module (WebLLM)
    // ============================================
    const LLMEngine = (() => {
      let engine = null;
      let isReady = false;

      async function initialize(onProgress) {
        try {
          console.log('üîÑ Loading LLM...');
          const { CreateMLCEngine } = await import('https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm@0.2.46/lib/index.min.js');
          
          // Using TinyLlama - smaller and more reliable
          engine = await CreateMLCEngine(
            "TinyLlama-1.1B-Chat-v1.0-q4f16_1-MLC",
            {
              initProgressCallback: (progress) => {
                if (onProgress) onProgress(progress);
              }
            }
          );
          
          isReady = true;
          console.log('‚úÖ LLM ready');
          return true;
        } catch (error) {
          console.error('‚ùå LLM loading failed:', error);
          throw error;
        }
      }

      async function chat(messages) {
        if (!isReady) throw new Error('LLM not ready');
        
        const response = await engine.chat.completions.create({
          messages: messages,
          temperature: 0.7,
          max_tokens: 512
        });
        
        return response.choices[0].message.content;
      }

      return { initialize, chat, isReady: () => isReady };
    })();

    // ============================================
    // Main Application
    // ============================================
    const App = (() => {
      const state = {
        files: [],
        chatHistory: [],
        isEmbeddingReady: false,
        isLLMReady: false,
        isProcessing: false
      };

      const elements = {
        dropZone: document.getElementById('dropZone'),
        fileInput: document.getElementById('fileInput'),
        fileCount: document.getElementById('fileCount'),
        vectorCount: document.getElementById('vectorCount'),
        memoryBank: document.getElementById('memoryBank'),
        chatContainer: document.getElementById('chatContainer'),
        chatInput: document.getElementById('chatInput'),
        sendBtn: document.getElementById('sendBtn'),
        clearBtn: document.getElementById('clearBtn'),
        embeddingStatus: document.getElementById('embeddingStatus'),
        llmStatus: document.getElementById('llmStatus'),
        processingStatus: document.getElementById('processingStatus'),
        inputHint: document.getElementById('inputHint')
      };

      const SYSTEM_PROMPT = `You are an expert Academic Research Assistant. Your role is to help users understand research papers by:
1. Analyzing the provided document excerpts carefully
2. Answering questions based ONLY on the given context
3. Being precise and citing which documents you're referencing
4. Admitting when information is not in the provided context

Always maintain an academic, professional tone.`;

      async function init() {
        console.log('üìö Initializing Application...');
        
        // Initialize both models in parallel
        await Promise.all([
          initializeEmbeddings(),
          initializeLLM()
        ]);
        
        setupEventListeners();
        checkReadyState();
      }

      async function initializeEmbeddings() {
        try {
          await EmbeddingsEngine.initialize();
          state.isEmbeddingReady = true;
          updateStatus(elements.embeddingStatus, '‚úì Embeddings Ready', 'success');
        } catch (error) {
          updateStatus(elements.embeddingStatus, '‚úó Embeddings Failed', 'error');
        }
      }

      async function initializeLLM() {
        try {
          await LLMEngine.initialize((progress) => {
            const percent = (progress.progress * 100).toFixed(0);
            updateStatus(elements.llmStatus, `Loading LLM: ${percent}%`, 'loading');
          });
          state.isLLMReady = true;
          updateStatus(elements.llmStatus, '‚úì LLM Ready', 'success');
        } catch (error) {
          updateStatus(elements.llmStatus, '‚úó LLM Failed', 'error');
        }
      }

      function updateStatus(element, text, type) {
        element.textContent = text;
        element.className = 'px-4 py-2 rounded-full text-sm font-semibold ';
        if (type === 'success') element.className += 'bg-green-500 text-white';
        else if (type === 'error') element.className += 'bg-red-500 text-white';
        else element.className += 'bg-yellow-400 text-gray-900';
      }

      function checkReadyState() {
        if (state.isEmbeddingReady && state.isLLMReady) {
          elements.chatInput.disabled = false;
          elements.sendBtn.disabled = false;
          elements.inputHint.textContent = 'Upload PDFs to start chatting, or ask general questions';
        }
      }

      function setupEventListeners() {
        elements.dropZone.addEventListener('click', () => elements.fileInput.click());
        elements.dropZone.addEventListener('dragover', (e) => {
          e.preventDefault();
          elements.dropZone.classList.add('bg-indigo-100');
        });
        elements.dropZone.addEventListener('dragleave', () => {
          elements.dropZone.classList.remove('bg-indigo-100');
        });
        elements.dropZone.addEventListener('drop', handleDrop);
        elements.fileInput.addEventListener('change', (e) => handleFiles(Array.from(e.target.files)));
        elements.sendBtn.addEventListener('click', handleSendMessage);
        elements.chatInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleSendMessage();
          }
        });
        elements.clearBtn.addEventListener('click', clearAllData);
      }

      function handleDrop(e) {
        e.preventDefault();
        elements.dropZone.classList.remove('bg-indigo-100');
        const files = Array.from(e.dataTransfer.files).filter(f => f.type === 'application/pdf');
        if (files.length > 0) handleFiles(files);
      }

      async function handleFiles(files) {
        if (!state.isEmbeddingReady) {
          alert('Please wait for embeddings to load');
          return;
        }

        state.isProcessing = true;

        for (const file of files) {
          await processAndEmbedFile(file);
        }

        state.isProcessing = false;
        updateUI();
      }

      async function processAndEmbedFile(file) {
        try {
          showProcessingStatus(`Processing ${file.name}...`, 0);
          const fileData = await PDFProcessor.processFile(file);
          
          showProcessingStatus(`Embedding ${file.name}...`, 0);
          const embeddings = await EmbeddingsEngine.generateBatchEmbeddings(
            fileData.chunks,
            (current, total) => {
              const progress = (current / total) * 100;
              showProcessingStatus(`Embedding ${file.name}: ${current}/${total}`, progress);
            }
          );

          const vectorEntries = fileData.chunks.map((chunk, idx) => ({
            text: chunk,
            embedding: embeddings[idx],
            source: file.name
          }));

          VectorStore.addVectors(vectorEntries);
          state.files.push(fileData);

          console.log(`‚úÖ Processed: ${file.name}`);
        } catch (error) {
          alert(`Error: ${error.message}`);
        }
      }

      function showProcessingStatus(message, progress) {
        elements.processingStatus.innerHTML = `
          <div class="mt-3 bg-indigo-50 rounded-lg p-3">
            <div class="text-sm text-indigo-700 mb-2">${message}</div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="bg-indigo-600 h-2 rounded-full transition-all" style="width: ${progress}%"></div>
            </div>
          </div>
        `;
      }

      async function handleSendMessage() {
        const query = elements.chatInput.value.trim();
        if (!query || !state.isLLMReady) return;

        elements.chatInput.value = '';
        elements.sendBtn.disabled = true;

        addMessageToChat('user', query);

        try {
          let context = '';
          let citations = [];

          // Retrieve relevant context if documents are available
          if (VectorStore.getStats().count > 0) {
            const queryEmbedding = await EmbeddingsEngine.generateEmbedding(query);
            const results = await VectorStore.search(queryEmbedding, 3);
            
            citations = results.map(r => ({
              source: r.source,
              text: r.text,
              similarity: r.similarity
            }));

            context = results.map((r, i) => 
              `[Document ${i+1}: ${r.source}]\n${r.text}`
            ).join('\n\n');
          }

          // Build messages array with chat history
          const messages = [
            { role: 'system', content: SYSTEM_PROMPT },
            ...state.chatHistory,
            { 
              role: 'user', 
              content: context ? 
                `Context from documents:\n${context}\n\nUser question: ${query}` : 
                query 
            }
          ];

          const response = await LLMEngine.chat(messages);

          // Update chat history
          state.chatHistory.push(
            { role: 'user', content: query },
            { role: 'assistant', content: response }
          );

          addMessageToChat('assistant', response, citations);

        } catch (error) {
          addMessageToChat('error', `Error: ${error.message}`);
        } finally {
          elements.sendBtn.disabled = false;
          elements.chatInput.focus();
        }
      }

      function addMessageToChat(role, content, citations = []) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'chat-message';

        if (role === 'user') {
          messageDiv.innerHTML = `
            <div class="flex justify-end mb-4">
              <div class="bg-indigo-600 text-white rounded-lg px-4 py-3 max-w-md">
                ${escapeHtml(content)}
              </div>
            </div>
          `;
        } else if (role === 'assistant') {
          let citationsHtml = '';
          if (citations.length > 0) {
            citationsHtml = `
              <div class="mt-2 pt-2 border-t border-gray-200">
                <div class="text-xs text-gray-500 mb-1">üìö Referenced documents:</div>
                ${citations.map(c => `
                  <span class="citation-badge bg-indigo-100 text-indigo-700" 
                        title="${escapeHtml(c.text.substring(0, 100))}...">
                    ${escapeHtml(c.source)} (${(c.similarity * 100).toFixed(0)}%)
                  </span>
                `).join('')}
              </div>
            `;
          }

          messageDiv.innerHTML = `
            <div class="flex justify-start mb-4">
              <div class="bg-white border border-gray-200 rounded-lg px-4 py-3 max-w-md shadow">
                <div class="flex items-start gap-2">
                  <span class="text-2xl">ü§ñ</span>
                  <div class="flex-1">
                    <div class="text-gray-800">${escapeHtml(content)}</div>
                    ${citationsHtml}
                  </div>
                </div>
              </div>
            </div>
          `;
        } else {
          messageDiv.innerHTML = `
            <div class="flex justify-center mb-4">
              <div class="bg-red-100 text-red-700 rounded-lg px-4 py-3">
                ${escapeHtml(content)}
              </div>
            </div>
          `;
        }

        elements.chatContainer.appendChild(messageDiv);
        elements.chatContainer.scrollTop = elements.chatContainer.scrollHeight;

        // Clear welcome message on first chat
        if (state.chatHistory.length === 0 && role === 'user') {
          elements.chatContainer.querySelector('.text-center')?.remove();
        }
      }

      function updateUI() {
        const stats = VectorStore.getStats();
        elements.fileCount.textContent = state.files.length;
        elements.vectorCount.textContent = stats.count;

        if (stats.count > 0) {
          elements.memoryBank.innerHTML = `
            <div class="space-y-2">
              <div class="text-sm"><strong>Vectors:</strong> ${stats.count}</div>
              <div class="text-sm"><strong>Documents:</strong></div>
              ${stats.sources.map(s => `<div class="text-xs opacity-90">‚Ä¢ ${s}</div>`).join('')}
            </div>
          `;
          elements.inputHint.textContent = 'Ask questions about your documents';
        }

        elements.processingStatus.innerHTML = '';
      }

      function clearAllData() {
        if (confirm('Clear all data and chat history?')) {
          VectorStore.clear();
          state.files = [];
          state.chatHistory = [];
          elements.chatContainer.innerHTML = `
            <div class="text-center text-gray-500 py-8">
              <div class="text-4xl mb-2">ü§ñ</div>
              <p>Upload PDFs and start chatting!</p>
            </div>
          `;
          updateUI();
        }
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML.replace(/\n/g, '<br>');
      }

      return { init };
    })();

    App.init();
  </script>
</body>
</html>